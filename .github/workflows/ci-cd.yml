name: CI/CD Pipeline

on:
  push:
    branches: [master]
  pull_request:
  workflow_dispatch:

jobs:
  code-checks:
    name: Code Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Lint
        run: npm run lint

      - name: Type check
        run: npm run astro check

  unit-tests:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: [code-checks]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests
        run: npm run test:coverage

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage/
          retention-days: 1

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    needs: [code-checks]
    environment: E2E Test
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright Browsers
        run: npx playwright install chromium --with-deps

      - name: Run E2E tests
        run: npm run test:e2e
        env:
          E2E_PASSWORD: ${{ secrets.E2E_PASSWORD }}
          E2E_USERNAME: ${{ secrets.E2E_USERNAME }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          

      - name: Upload Playwright report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 1

  build:
    name: Build
    runs-on: ubuntu-latest
    needs: [e2e-tests, unit-tests]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
        env:

          NODE_ENV: production

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/

  deploy-migrations:
    name: Deploy Migrations
    runs-on: ubuntu-latest
    environment: Production
    env:
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_ACCESS_TOKEN: ${{ secrets.SUPABASE_ACCESS_TOKEN }}
    needs: [build]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Supabase CLI
        uses: supabase/setup-cli@v1
        with:
          version: latest

      - name: Link Supabase project
        run: supabase link --project-ref ${{ secrets.SUPABASE_PROJECT_ID }}
      - name: Push migrations
        run: supabase db push 



  deploy:
    name: Deploy 
    runs-on: ubuntu-latest
    environment: Production
    needs: [deploy-migrations]
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/
      
      - name: Deploy to Cloudflare
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name=10x-recipes


  pr-status:
    name: PR Status
    runs-on: ubuntu-latest
    needs: [code-checks, unit-tests, e2e-tests]
    if: always() && github.event_name == 'pull_request'
    permissions:
      pull-requests: write
    steps:
      - name: Post CI Status to PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: workflowJobs } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: context.runId
            });

            const ciJobNames = ['Code Checks', 'Unit Tests', 'E2E Tests'];
            const ciJobs = workflowJobs.jobs
              .filter(j => ciJobNames.includes(j.name))
              .sort((a, b) => ciJobNames.indexOf(a.name) - ciJobNames.indexOf(b.name));

            const statusIcon = (conclusion) => {
              switch (conclusion) {
                case 'success': return 'âœ…';
                case 'failure': return 'âŒ';
                case 'cancelled': return 'âšª';
                case 'skipped': return 'â­ï¸';
                default: return 'ðŸ”„';
              }
            };

            const formatDuration = (start, end) => {
              if (!start || !end) return '-';
              const ms = new Date(end) - new Date(start);
              const minutes = Math.floor(ms / 60000);
              const seconds = Math.floor((ms % 60000) / 1000);
              return minutes > 0 ? `${minutes}m ${seconds}s` : `${seconds}s`;
            };

            const allPassed = ciJobs.every(j => j.conclusion === 'success');
            const anyFailed = ciJobs.some(j => j.conclusion === 'failure');

            let header;
            if (anyFailed) {
              header = '## âŒ CI Pipeline â€” Failed';
            } else if (allPassed) {
              header = '## âœ… CI Pipeline â€” All Checks Passed';
            } else {
              header = '## âš ï¸ CI Pipeline â€” Completed with warnings';
            }

            // Build results table
            let table = '| Job | Status | Duration |\n';
            table += '|-----|--------|----------|\n';
            for (const job of ciJobs) {
              const icon = statusIcon(job.conclusion);
              const status = job.conclusion ?? 'pending';
              const duration = formatDuration(job.started_at, job.completed_at);
              const link = `[${job.name}](${job.html_url})`;
              table += `| ${link} | ${icon} ${status} | ${duration} |\n`;
            }

            // Failed jobs details with failed steps
            const failedJobs = ciJobs.filter(j => j.conclusion === 'failure');
            let failedDetails = '';
            if (failedJobs.length > 0) {
              failedDetails = '\n### Failed Jobs\n\n';
              for (const job of failedJobs) {
                const failedSteps = (job.steps ?? []).filter(s => s.conclusion === 'failure');
                failedDetails += `<details>\n<summary><strong>${job.name}</strong></summary>\n\n`;
                if (failedSteps.length > 0) {
                  failedDetails += 'Failed steps:\n';
                  for (const step of failedSteps) {
                    failedDetails += `- \`${step.name}\`\n`;
                  }
                }
                failedDetails += `\n[View full logs](${job.html_url})\n\n</details>\n\n`;
              }
            }

            const sha = context.payload.pull_request.head.sha.substring(0, 7);
            const runUrl = `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            const footer = `---\n*Run [#${context.runNumber}](${runUrl}) | Commit \`${sha}\` | Automated by GitHub Actions*`;

            const marker = '<!-- ci-pipeline-status -->';
            const body = `${marker}\n${header}\n\n${table}\n${failedDetails}${footer}`;

            // Create or update existing comment to avoid spam
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existing = comments.find(c => c.body?.includes(marker));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body
              });
            }
