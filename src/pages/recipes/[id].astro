---
import { z } from "zod";
import Layout from "../../layouts/Layout.astro";
import RecipeDetailView from "../../components/recipes/detail/RecipeDetailView";
import type { RecipeDetailDto } from "../../types";
import { getRecipeDetail } from "../../lib/services/recipes/getRecipeDetail";
import type { RecipeDetailError } from "../../lib/services/recipes/getRecipeDetail";

const idSchema = z.string().uuid("Recipe id must be a valid UUID.");
const { id } = Astro.params;
const recipeId = id ?? "";

let initialDetail: RecipeDetailDto | null = null;
let errorMessage: string | null = null;
let notFound = false;

// Check if user is authenticated
const user = Astro.locals.user;
if (!user) {
  return Astro.redirect(`/auth/login?redirectTo=${encodeURIComponent(Astro.url.pathname)}`);
}

if (!id || !idSchema.safeParse(id).success) {
  notFound = true;
  errorMessage = "Recipe not found.";
} else {
  try {
    const supabase = Astro.locals.supabase;
    initialDetail = await getRecipeDetail(supabase, user.id, id);
  } catch (error) {
    const detailError = error as RecipeDetailError | undefined;
    if (detailError?.code === "NOT_FOUND") {
      notFound = true;
      errorMessage = "Recipe not found.";
    } else {
      errorMessage = "Unable to load recipe details. Please try again later.";
    }
  }
}
---

<Layout title="Recipe Details">
  {
    notFound || !initialDetail ? (
      <section class="rounded-lg border border-border bg-card p-6 text-card-foreground">
        <h1 class="text-xl font-semibold">Recipe not found</h1>
        <p class="mt-2 text-sm text-muted-foreground">{errorMessage}</p>
        <a class="mt-4 inline-flex text-sm font-medium text-primary hover:underline" href="/recipes">
          Back to recipes
        </a>
      </section>
    ) : (
      <RecipeDetailView initialDetail={initialDetail} recipeId={recipeId} client:load />
    )
  }
</Layout>
